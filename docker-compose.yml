# /opt/infra/stacks/ingest/docker-compose.yml
services:
  ingestor:
    build: ./services/raw-writer
    environment:
      # --- Postgres (provided by Vault Agent / mounted secret file) ---
      PG_DSN_FILE: "/secrets/pg_dsn"

      # --- Logging/diagnostics ---
      LOG_LEVEL: "DEBUG"           # INFO | DEBUG
      PYTHONUNBUFFERED: "1"        # unbuffered stdout/stderr in Docker
      DEBUG_SAMPLE_N: "1"          # log every payload body (0 disables)

      # --- Metrics & heartbeat (also emitted to MQTT if enabled) ---
      METRICS_INTERVAL_SEC: "10"   # emit metrics every 10s
      HEARTBEAT_INTERVAL_SEC: "10"
      METRICS_MQTT: "1"            # publish metrics/heartbeat to MQTT

      # --- Feature flags (switch to "1" to disable the feature) ---
      DISABLE_VALUES: "0"          # 1 = skip INSERTs into data_values
      DISABLE_REPUBLISH: "0"       # 1 = skip MQTT republish

      # --- Optional: very noisy wire-level MQTT tracing ---
      # PAHO_TRACE: "1"

      # --- Optional: if running multiple instances, customize client id prefix ---
      # CLIENT_ID_PREFIX: "raw-writer"

      # Health reporting shared library
      PYTHONPATH: "/opt"

    restart: always

    volumes:
      # Vault Agent (or other secret injector) should render DSN to this path
      - ./secrets:/secrets:ro
      - ./software_module_health:/opt/software_module_health:ro

    # Simple healthcheck (process up)
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 5s
      retries: 3

    networks:
      - infra

  # Sidecar: Vault Agent for raw-writer
  vault-agent-raw-writer:
    image: hashicorp/vault:1.21.1
    restart: always
    labels:
      com.prometrics.sidecar: "true"
      com.prometrics.sidecar_for: "ingestor"
    command: >
      sh -lc "vault agent -config=/vault/config/vault-agent.hcl"
    volumes:
      - ./secrets:/secrets:rw
      - ./vault-agent/vault-agent.hcl:/vault/config/vault-agent.hcl:ro
      - ./vault-agent/pg_dsn.tpl:/vault/templates/pg_dsn.tpl:ro
      - ./vault-agent/approle:/vault/approle:rw
      - ./:/stack:ro
      - /opt/infra/stacks/vault/tls/ca.crt:/vault/tls/ca.crt:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker:ro
      - /lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu:ro
      - /lib64:/lib64:ro
    networks:
      - infra

networks:
  infra:
    external: true
